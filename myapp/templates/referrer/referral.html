{% extends "base.html" %}

{% block title %}Refer a Candidate{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-4">Refer a Candidate</h1>
        <p class="text-lg text-gray-600">Upload the CV of the candidate you want to refer.</p>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title mb-4">Referral Information</h2>
                <form method="POST" action="{{ url_for('referrer.referrals') }}" enctype="multipart/form-data" class="space-y-6">
                    <div class="flex items-center gap-8 mb-6 p-4 rounded-lg w-full overflow-visible whitespace-nowrap" style="background: none;">
                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-4" for="fresher-toggle">
                                <input type="checkbox" id="fresher-toggle" name="is_fresher" class="checkbox checkbox-primary" {% if form_data and form_data.is_fresher %}checked{% endif %} />
                                <span class="label-text">Fresher</span>
                            </label>
                        </div>
                        <div id="job-listing-section" class="form-control min-w-[300px]" style="display: none; position: relative; z-index: 30;">
                            <label class="label" for="job_listing_id">
                                <span class="label-text">Job Listing <span class="text-error">*</span></span>
                            </label>
                            <div id="vue-joblisting-select"></div>
                            <input type="hidden" name="job_listing_id" id="job_listing_id" value="{{ form_data.job_listing_id if form_data else '' }}" />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-control">
                            <label class="label" for="name">
                                <span class="label-text">Name</span>
                            </label>
                            <input
                                id="name"
                                type="text"
                                name="name"
                                required
                                placeholder="Enter full name"
                                pattern="[A-Za-z\s]+"
                                title="Please enter a valid name (letters and spaces only)"
                                class="input input-bordered"
                                value="{{ form_data.name if form_data else '' }}"
                            />
                        </div>
                        <div class="form-control">
                            <label class="label" for="cvFile">
                                <span class="label-text">CV Upload</span>
                            </label>
                            <div class="space-y-2">
                                <input
                                    type="file"
                                    name="cv"
                                    id="cvFile"
                                    class="file-input file-input-bordered w-full"
                                    accept=".pdf,.docx"
                                    required
                                />
                                <p class="text-sm text-gray-500">Accepted formats: PDF or DOCX (Max size: 5MB)</p>
                                <p id="fileError" class="text-error text-sm"></p>
                            </div>
                        </div>
                    </div>
                    <div class="form-control mt-6">
                        <button type="submit" class="btn btn-primary" id="submitBtn">Submit Application</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-multiselect@2.1.6"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash.debounce@4.0.8/index.js"></script>
<script src="https://unpkg.com/vue-virtual-scroller@1.0.10/dist/vue-virtual-scroller.umd.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('cvFile');
        const errorElement = document.getElementById('fileError');
        const fresherToggle = document.getElementById('fresher-toggle');
        const jobListingSection = document.getElementById('job-listing-section');
        const jobListingInput = document.getElementById('job_listing_id');
        const submitBtn = document.getElementById('submitBtn');

        // File validation
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const fileSizeMB = file.size / (1024 * 1024);
                    if (fileSizeMB > 5) {
                        errorElement.textContent = `File size (${fileSizeMB.toFixed(2)} MB) exceeds the 5MB limit`;
                        errorElement.style.color = 'red';
                        this.value = '';
                        submitBtn.disabled = true;
                    } else {
                        errorElement.textContent = '';
                        submitBtn.disabled = false;
                    }
                }
            });
        }

        // Fresher checkbox logic
        function toggleJobListingSection() {
            if (!fresherToggle.checked) {
                jobListingSection.style.display = 'block';
                jobListingInput.setAttribute('required', 'required');
            } else {
                jobListingSection.style.display = 'none';
                jobListingInput.removeAttribute('required');
                jobListingInput.value = '';
            }
        }
        if (fresherToggle) {
            fresherToggle.addEventListener('change', toggleJobListingSection);
            toggleJobListingSection(); // Set initial state
        }

        // Vue Multiselect for Job Listing
        if (document.getElementById('vue-joblisting-select')) {
            Vue.component('virtual-list', window.VueVirtualScroller.VirtualList);
            new Vue({
                el: '#vue-joblisting-select',
                components: {
                    Multiselect: window.VueMultiselect.default,
                    VirtualList: window.VueVirtualScroller.VirtualList
                },
                data: function() {
                    const jobListings = JSON.parse('{{ job_listings|tojson|safe }}');
                    const initial = "{{ form_data.job_listing_id if form_data else '' }}";
                    return {
                        jobListingOptions: jobListings,
                        selectedJobListing: jobListings.find(j => j.id == initial) || null,
                        searchQuery: '',
                        filteredJobListings: jobListings
                    };
                },
                mounted() {
                    this.filteredJobListings = this.jobListingOptions;
                },
                methods: {
                    customLabel(job) {
                        return job && job.title ? job.title : '';
                    },
                    onSearchChange: _.debounce(function(query) {
                        this.searchQuery = query;
                        this.filteredJobListings = this.jobListingOptions.filter(job =>
                            job.title.toLowerCase().includes(query.toLowerCase())
                        );
                    }, 300),
                    selectJobListing(item) {
                        this.selectedJobListing = item;
                    }
                },
                watch: {
                    selectedJobListing(val) {
                        document.getElementById('job_listing_id').value = val && val.id ? val.id : '';
                    }
                },
                template: `
                    <multiselect
                        v-model="selectedJobListing"
                        :options="filteredJobListings"
                        :searchable="true"
                        :internal-search="false"
                        :clear-on-select="false"
                        :close-on-select="true"
                        :show-labels="false"
                        :custom-label="customLabel"
                        placeholder="Select a job listing"
                        @search-change="onSearchChange"
                        label="title"
                        track-by="id"
                        :option-height="40"
                        :max-height="220"
                    >
                        <template slot="option" slot-scope="{ option }">
                            <div>{{ option.title }}</div>
                        </template>
                        <template slot="singleLabel" slot-scope="{ option }">
                            <div>{{ option.title }}</div>
                        </template>
                        <template slot="afterList">
                            <div v-if="filteredJobListings.length === 0" class="px-4 py-2 text-gray-500">No job listings found</div>
                        </template>
                    </multiselect>
                `
            });
        }
    });
</script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vue-multiselect@2.1.6/dist/vue-multiselect.min.css">
<link rel="stylesheet" href="https://unpkg.com/vue-virtual-scroller@1.0.10/dist/vue-virtual-scroller.css">
<style>
.search-box {
    overflow: visible;
    position: relative;
    width: 100%;
}
.search-input {
    border-radius: 0.5rem;
    border: 1px solid #d1d5db;
    box-shadow: none;
    background: #fff;
    z-index: 2;
}
.options-list {
    overflow: visible;
    border-radius: 0.5rem;
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    min-width: 100%;
    background: #fff;
    border: 1px solid #d1d5db;
    border-top: none;
    border-radius: 0 0 0.5rem 0.5rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    max-height: 220px;
    overflow-y: auto;
    z-index: 100;
    padding: 0.25rem 0;
    margin-top: -2px;
    display: none;
}
.options-list.show {
    display: block;
}
.multiselect__option {
  padding: 8px;
  cursor: pointer;
}
.multiselect__option:hover {
  background-color: #f0f0f0;
}
</style>
{% endblock %}
